# Финальная архитектура промптов, флоу в админке и политика для Gemini

## 1. Как я вижу систему в итоге

### Слои конфигурации (сверху вниз)

| Слой | Где хранится | Что задаёт |
|------|----------------|-----------|
| **Глобальный промпт (мастер)** | `generation_prompt_settings` (одна запись) | SYSTEM-поведение, DEFINITIONS (Image A/B), PRIORITY ORDER, общие HARD IDENTITY RULES, **NEGATIVE_CONSTRAINTS** (общий блок), SAFETY, OUTPUT-шаблон, дефолты модели. |
| **Тренд** | `trends` | Сцена (scene), перенос лица/тела (subject), негатив тренда (дополнение к общему), опционально свой output. |
| **Запрос** | джоб + фото пользователя | Выбранный тренд + референс(ы) → финальная склейка. |

Общее правило: **общие блоки (NEGATIVE_CONSTRAINTS, SAFETY, identity rules) задаются один раз в глобальном промпте.** Тренд только добавляет свой контент (сцена, субъект, при необходимости — доп. негатив), не дублирует общие блоки.

---

## 2. Сущности (что конфигурируется)

### 2.1 Глобальный промпт (расширение текущего `generation_prompt_settings`)

Сейчас есть: `system_prompt_prefix`, `negative_prompt_prefix`, `safety_constraints`, `image_constraints_template` + дефолты модели.

Добавить (или уже держать в одном большом текстовике с секциями):

- **definitions** — короткий текст: что такое Image A (TREND) и Image B (REFERENCE). Вставляется в системный промпт один раз.
- **priority_order** — текст или структура: «1) субъекты из B, 2) композиция, 3) стиль тренда».
- **identity_rules** — список жёстких правил по лицу/телу из референса (каждый пункт — строка; вкл/выкл целиком или по пунктам).
- **negative_constraints** — **общий блок [NEGATIVE_CONSTRAINTS]** (то, о котором ты говорил): один текст или список пунктов, общий для всех трендов. В финальный промпт подставляется один раз.

Тренд при этом может иметь поле `negative_prompt` (или `negative_append`) — дополнение к общему негативу только для этого тренда.

### 2.2 Тренд (расширение текущего `trends`)

Сейчас: `name`, `emoji`, `description`, `system_prompt`, `negative_prompt`, `style_preset`, `max_images`, `enabled`, `order_index`, `example_image_path`.

Имеет смысл логически разделить контент тренда на:

- **scene** — описание сцены, окружения, света, стиля (как должно выглядеть изображение).
- **subject** — описание переноса: поза, действие, одежда, как использовать лицо/тело из референса.

Варианты реализации:

- **Вариант A:** Оставить один `system_prompt`, но в админке показывать два поля (Сцена / Перенос) и при сохранении склеивать в один текст (или хранить два поля `scene_prompt`, `subject_prompt` и склеивать при сборке).
- **Вариант B:** Добавить в модель `scene_prompt` и `subject_prompt`; старый `system_prompt` считать legacy и при сборке собирать из scene + subject.

Для единообразия с «все тренды знают про сцену и перенос» лучше явные поля **scene** и **subject** (или один составной промпт с подзаголовками [SCENE] / [SUBJECT] в одном поле).

### 2.3 Сборка финального промпта (порядок блоков)

Рекомендуемый порядок в одном тексте, который уходит в Gemini:

1. **SYSTEM** — роль и «Follow instructions exactly. No explanations, no captions.»
2. **DEFINITIONS** — Image A (TREND), Image B (REFERENCE).
3. **PRIORITY ORDER** — что важнее при конфликте.
4. **HARD IDENTITY RULES** — из глобального конфига.
5. **TREND** — [SCENE] и [SUBJECT] (или один блок TREND из scene + subject).
6. **[NEGATIVE_CONSTRAINTS]** — общий блок (один раз из глобального конфига).
7. Негатив тренда (если есть) — как дополнение (например, «negative_prompt: …» или отдельная секция).
8. **SAFETY** — без текста в картинке, без чата и т.д.
9. **OUTPUT** — один кадр, aspect_ratio, format.

Так и флоу «фото как отдельная сущность с промптом», и «все тренды знают про сцену и перенос» соблюдаются: референс = Image B, тренд = сцена + перенос, общие вещи не дублируются.

---

## 3. Флоу в админке (настройка и использование)

### 3.1 Где что настраивается

- **Промпт генерации** (уже есть страница «Промпт генерации»):
  - Системный префикс (SYSTEM).
  - Definitions (Image A / Image B) — добавить секцию или текст.
  - Priority order — текст или структурированный список.
  - Identity rules — список пунктов с вкл/выкл.
  - **NEGATIVE_CONSTRAINTS** — один общий блок (текст или список пунктов); подпись секции может быть буквально `[NEGATIVE_CONSTRAINTS]`.
  - Safety constraints (уже есть).
  - Шаблон ограничений изображения / OUTPUT (уже есть).
  - Дефолты модели (модель, размер, формат, temperature).

- **Тренды** (список трендов → редактирование тренда):
  - Мета: название, emoji, описание, порядок, вкл/выкл, пример картинки.
  - Контент промпта:
    - Сцена (или один общий system_prompt с подсказкой «можно разбить на Сцену и Перенос»).
    - Перенос лица/тела (subject).
  - Негатив тренда — только дополнение к общему (не дублировать общий NEGATIVE_CONSTRAINTS).
  - При желании — переопределение output для тренда (aspect_ratio, format).

- **Промпты** (если у вас отдельно «Prompts» для чего-то ещё) — оставить как есть или свести к «переопределениям на тренд» (как сейчас trend_prompt overrides).

### 3.2 Типичный сценарий в админке

1. Зайти в **Промпт генерации** — один раз задать общие блоки: SYSTEM, DEFINITIONS, PRIORITY, identity rules, **NEGATIVE_CONSTRAINTS**, SAFETY, OUTPUT, дефолты модели. Сохранить.
2. Зайти в **Тренды** — для каждого тренда задать сцену и перенос (или один system_prompt), при необходимости — доп. негатив и output. Сохранить.
3. Пользователь в боте загружает фото и выбирает тренд → бэкенд собирает промпт из глобального конфига + выбранного тренда и шлёт в Gemini.

Никакого дублирования общего негатива по трендам: он задаётся один раз в «Промпт генерации».

---

## 4. Политика промпта для Gemini (как я бы делал в 2026)

### 4.1 Структура запроса к API

- **Контент (contents):**
  - Сначала все референсные изображения (Image B) — по одному part на изображение.
  - Один текстовый part: полный промпт, собранный по порядку из пункта 2.3 (SYSTEM → … → OUTPUT). Внутри текста — чёткие секции с подзаголовками [SYSTEM], [DEFINITIONS], [PRIORITY], [IDENTITY RULES], [TREND], [NEGATIVE_CONSTRAINTS], [SAFETY], [OUTPUT], чтобы модель стабильно их различала.

### 4.2 Что явно задавать

- **Один текстовый запрос** — без отдельного «system» и «user» в мультимодальном смысле: Gemini получает один user turn с картинками + один текст. Роль и инструкции — внутри этого текста в секциях, чтобы не зависеть от разного трактования system vs user.
- **Negative:** и общий блок [NEGATIVE_CONSTRAINTS], и негатив тренда — в том же текстовом part, например в конце перед SAFETY/OUTPUT: «Avoid: …» или отдельная секция. Так политика «негатив общий + дополнение по тренду» одна и та же для всех провайдеров, а для Gemini при необходимости можно префикс «Avoid:» оставить (как у вас уже есть в коде).
- **Identity:** жёсткие правила («не менять лицо», «все люди из B в кадре») — в начале, в [IDENTITY RULES], и по возможности формулировать коротко и однозначно.

### 4.3 Безопасность и стабильность

- **Safety** — отдельная секция в промпте (no text in image, no chat, no explanations) и по возможности дублировать настройками API (Gemini safety settings), если у API есть такие параметры.
- **Длина:** при очень длинном промпте приоритет — DEFINITIONS, PRIORITY, IDENTITY, TREND (scene + subject), NEGATIVE_CONSTRAINTS, SAFETY, OUTPUT. Обрезку делать с конца менее критичных частей или сжимать только «описательные» куски тренда, не трогая правила.

### 4.4 Итог по политике для Gemini

- Один user message: [images] + [one text with sections].
- Секции в фиксированном порядке; общие блоки (в т.ч. **[NEGATIVE_CONSTRAINTS]**) задаются в глобальном конфиге и подставляются один раз.
- Тренд добавляет только сцену, перенос и опционально доп. негатив.
- Так флоу в админке простой (общее в одном месте, по трендам — только отличия), а поведение модели предсказуемо и единообразно.

---

*Документ можно использовать как спецификацию для доработки `generation_prompt_settings`, экрана «Промпт генерации» и сборки промпта в воркере под Gemini.*
