# Расследование: потеря данных в БД

## Итог

**Вероятная причина потери «прошлых результатов» — удаление Docker volume с данными PostgreSQL.** Данные не удалялись из кода приложения (нет DROP/TRUNCATE таблиц в миграциях и сервисах). Удаление могло произойти только на уровне инфраструктуры.

---

## Что проверено

### 1. Код приложения — не удаляет данные БД

- **Миграции** (`migrations/schema.sql`, все `migrations/*.sql`): только `CREATE TABLE IF NOT EXISTS` и `ALTER TABLE` / добавление колонок. **Нет `DROP TABLE`, `TRUNCATE`, массового `DELETE`.**
- **Cleanup-сервис** (`app/services/cleanup/service.py`): удаляет только **временные файлы на диске** (пути из `Job.input_local_paths`) и обнуляет эти поля в записях Job. **Записи пользователей и джобов из БД не удаляет.**
- **Сид трендов** (`migrations/seed/001_trends.sql`): выполняется в `start.sh` **только если** `SELECT COUNT(*) FROM trends` вернул 0. То есть заполняет тренды только при пустой таблице, не трогает пользователей и джобы.

### 2. Единственное место, где данные БД теряются — удаление volume

- **`./stop.sh -v`** или **`./stop.sh --volumes`**  
  Выполняет:
  - `docker compose down -v` — останавливает контейнеры и **удаляет именованные volumes** (в т.ч. `postgres_data`);
  - `docker volume rm ai_slop_2_postgres_data` — принудительно удаляет volume с данными PostgreSQL.
- **`./stop.sh --full`**  
  Включает в себя `REMOVE_VOLUMES=true`, то есть делает то же удаление volume.

После следующего `./start.sh`:

- Поднимается новый контейнер PostgreSQL с **новым пустым** volume;
- Применяются миграции (создаются пустые таблицы);
- Сид заполняет только `trends` (11 записей), т.к. таблица пуста;
- Пользователи и джобы **нигде не восстанавливаются** — остаётся 0 users, 0 jobs до первого нового входа.

**Вывод:** если кто-то (вы или другой человек с доступом к серверу/репозиторию) запускал `./stop.sh -v` или `./stop.sh --full`, все данные БД (пользователи, джобы, аудит, токены и т.д.) были удалены вместе с volume.

### 3. Текущий volume — «свежий»

- Volume: `ai_slop_2_postgres_data`
- **CreatedAt:** `2026-01-31T20:25:07+01:00`

То есть этот экземпляр данных PostgreSQL существует только с этой даты. Либо это первый запуск проекта в этой среде, либо старый volume был удалён (в т.ч. через `stop.sh -v/--full`), и при следующем `start.sh` создался новый volume — тогда «прошлые результаты» были в старом volume и потеряны безвозвратно (если не было бэкапов).

---

## Как такое могло произойти

1. **Случайный запуск** `./stop.sh -v` или `./stop.sh --full` (например, по документации «полная очистка» или по привычке «почистить всё»).
2. **Ручное удаление volume:**  
   `docker compose down -v` или `docker volume rm ai_slop_2_postgres_data` (или аналог с другим префиксом проекта).
3. **Перенос/перезапуск проекта на другой машине** без переноса volume или дампов — на новом месте поднялась новая БД без старых данных.
4. **Восстановление из бэкапа/клона**, где был пустой или старый снимок БД — визуально выглядит как «кто-то удалил базу».

В коде и скриптах **нет** «скрытого» сценария, который бы сам по себе дропал таблицы или очищал всех пользователей/джобы — только удаление volume через `stop.sh` с флагами `-v`/`--full` или ручные команды Docker.

---

## Рекомендации

1. **Не использовать `./stop.sh -v` и `./stop.sh --full`** без явной необходимости полностью выкинуть данные (например, тестовый стенд). Для обычной остановки использовать просто `./stop.sh`.
2. **Регулярные бэкапы БД:**  
   Например, cron:  
   `docker compose exec -T db pg_dump -U trends trends | gzip > backup_trends_$(date +%Y%m%d_%H%M).sql.gz`  
   и хранение последних N бэкапов на отдельном хранилище.
3. **Документировать опасность:** в README или в выводе `./stop.sh --help` явно указать, что `-v` и `--full` удаляют все данные БД без возможности восстановления (если нет бэкапов).
4. **Опционально:** перед удалением volume в `stop.sh` при `-v`/`--full` делать проверку (например, запрос подтверждения или требовать переменную окружения типа `CONFIRM_DESTROY_DB=yes`), чтобы снизить риск случайного запуска.

---

*Отчёт составлен по результатам проверки кода и инфраструктуры проекта (дата проверки: 2026-02-03).*
