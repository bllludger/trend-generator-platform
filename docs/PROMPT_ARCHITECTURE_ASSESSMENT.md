# Нормально ли так делать? Оценка архитектуры промптов

Кратко: **разделение «глобальные правила vs тренд» — нормально. Лишнего действительно много: мёртвый код, неиспользуемые поля, два разных билдера, YAML «для генерации», который генерация не читает.**

---

## Что нормально (оставлять как есть)

| Что | Зачем |
|-----|--------|
| **Два флоу (Тренд / Copy Style)** | Разные сценарии: «подставить лицо в сцену тренда» vs «сделать в стиле двух фото». Один источник на флоу — ок. |
| **Transfer Policy отдельно от тренда** | Глобальные правила переноса личности и AVOID — одна запись; сцены — по трендам. Так и должно быть. |
| **Тренд = сцена + стиль + негатив + референс** | Всё, что меняется от тренда к тренду, лежит в одном месте (таблица `trends`). |
| **Одна точка сборки в флоу «Тренд»** | `build_final_prompt(transfer_policy, trend, output_spec, safety_policy)` — один билдер, предсказуемо. |

Итого: **идея «глобальные настройки + тренд» не перегружена. Перегружены реализация и обвязка.**

---

## Что лишнее (создаёт кашу)

### 1. Два билдера промпта, один не используется

- **`build_trend_prompt(cfg, trend, size, format, model)`** — структура [SYSTEM], [DEFINITIONS], [PRIORITY ORDER], [IDENTITY RULES], [SCENE], [SUBJECT TRANSFER], [NEGATIVE], [SAFETY], [OUTPUT]. Использует `GenerationPromptSettingsService` (все блоки).
- **`build_final_prompt(transfer_policy, trend, output_spec, safety_policy)`** — структура [INPUT], [TASK], [IDENTITY TRANSFER], [COMPOSITION], [SCENE], [STYLE], [AVOID], [SAFETY], [OUTPUT]. Использует только Transfer Policy + Trend + один кусок из настроек (safety).

Воркер вызывает **только** `build_final_prompt`. `build_trend_prompt` в воркере **нигде не вызывается** (только импорт). Итог: два разных «источника правды» по структуре промпта, из них один мёртвый — путаница и риск править не то.

### 2. Generation Prompt Settings: много полей, в Тренде используются четыре

В флоу «Тренд» из `generation_prompt_settings` реально идут только:

- `default_model`
- `default_size`
- `default_format`
- `safety_constraints`

Остальное (`system_prompt_prefix`, `definitions`, `priority_order`, `identity_rules`, `negative_constraints`, `negative_prompt_prefix`, `image_constraints_template` и т.д.) в этом флоу **не используется** — их читает только `build_trend_prompt`, который воркер не вызывает. Получается: большая страница в админке и таблица в БД, которые на основной сценарий не влияют.

### 3. YAML «для генерации» — генерация его не читает

- При сохранении тренда в админке вызывается `PromptService.update_trend()` → пишется `prompts/trends/*.yaml`.
- Воркер (`generation.py`) читает только БД (Trend, Transfer Policy, Generation Prompt Settings). YAML в этом пути **нигде не используется**.
- YAML читают админка (API trend-prompts) и, при необходимости, `generation_v2`. То есть это экспорт/бэкап/отдельный сценарий, а не «источник промпта для основной генерации».

Итог: формулировка «генерация читает промпты из YAML» неверна для основного флоу; лишняя синхронизация и ожидания «поменял YAML — поменялась генерация» создают путаницу.

### 4. Три «входа» в админке для одного запроса

Чтобы понять, откуда берётся итоговый промпт по тренду, нужно смотреть:

- Тренды (сцена, стиль, негатив, референс),
- Перенос личности (Transfer Policy),
- Настройки генерации (Generation Prompt).

Для модели/размера/формата и одной фразы safety — нормально. Но то, что полстраницы «Промпт генерации» (system_prompt_prefix, definitions и т.д.) в основном флоу не участвует, неочевидно и выглядит как «слишком много всего».

---

## Итог: нормально ли так делать?

- **По идее** — да: глобальные правила (Transfer Policy) + данные тренда (Trend) + общие параметры запроса (модель, размер, формат, safety) — нормальная схема.
- **По факту** — избыточно: два билдера (один мёртвый), куча неиспользуемых полей в настройках генерации, YAML, который вы подаёте как часть «промптов для генерации», хотя основной воркер его не читает.

То есть **архитектура «кто за что отвечает» — ок; лишнее — мёртвый код, неиспользуемые поля и лишние ожидания от YAML.**

---

## Что можно сделать (упрощение)

### Вариант A. Минимальная зачистка (без смены поведения)

1. **Документация и комментарии**
   - Явно написать: «Для флоу „Тренд“ итоговый промпт собирает только `build_final_prompt`; YAML на генерацию не влияет (экспорт/бэкап).»
   - В админке на странице «Промпт генерации» помечать: «В флоу по трендам сейчас используются только: модель, размер, формат, блок Safety.»

2. **Убрать мёртвый импорт**
   - В `generation.py` не импортировать и не использовать `build_trend_prompt` (оставить только `build_final_prompt` и что реально нужно).

3. **YAML**
   - Либо оставить синхронизацию, но везде называть её «экспорт/бэкап трендов в YAML», либо убрать запись YAML при сохранении тренда, если никто не пользуется файлами.

Так ты не меняешь логику, но уменьшаешь путаницу и количество «ложных» точек входа.

### Вариант B. Свести к одному билдеру (средний объём работ)

1. **Один билдер для флоу «Тренд»**
   - Либо выкинуть `build_trend_prompt` и везде (в т.ч. в админке, если есть превью) использовать `build_final_prompt` / `build_final_prompt_payload`.
   - Либо наоборот: доработать один билдер (например, `build_final_prompt`), чтобы он при необходимости подмешивал опциональные блоки из настроек (например, один общий префикс), и вызывать только его.

2. **Настройки генерации**
   - Либо убрать из UI/БД поля, которые не используются в выбранном билдере, оставив модель, размер, формат, safety.
   - Либо один раз подключить к билдеру 1–2 осмысленных поля (например, общий префикс к промпту) и больше не плодить блоки.

3. **YAML**
   - Решить: только экспорт (и так и писать в доке) или полное отключение синхронизации.

Тогда «как собирается промпт» будет одним способом, а не двумя разными.

### Вариант C. Жёсткое упрощение (максимально мало сущностей)

1. **Один «глобальный» конфиг**
   - Объединить Transfer Policy и «используемую часть» Generation Prompt Settings в одну сущность/страницу (например, «Настройки генерации» = модель, размер, формат, safety + правила переноса личности + AVOID). Тренд по‑прежнему только «сцена + стиль + негатив + референс».

2. **Один билдер**
   - Как в варианте B: один способ сборки промпта для флоу «Тренд».

3. **YAML**
   - Не писать при сохранении тренда или явно считать «экспорт для бэкапа/ручного редактирования», без обещаний «генерация читает отсюда».

Итог: меньше таблиц/страниц в админке, одна цепочка «глобальные настройки → тренд → билдер → запрос».

---

## Рекомендация

- **Краткосрочно:** сделать вариант A (документация, убрать мёртвый импорт, прояснить роль YAML). Это быстро и без риска.
- **Среднесрочно:** вариант B — один билдер, почистить или явно использовать поля «Промпт генерации», зафиксировать роль YAML. Тогда «нормально ли так делать» станет «да, и понятно, что откуда берётся».
- Вариант C — если хочется радикально уменьшить количество сущностей; он уже про рефакторинг продукта, а не только про промпты.

Если нужно, могу расписать конкретные шаги по варианту A (патчи/коммиты) по файлам.
