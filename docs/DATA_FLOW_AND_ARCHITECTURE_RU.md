# –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∏ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –¥–≤–∏–∂—É—Ç—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞—Ç–Ω–æ.

---

## 1. –û–±—â–∞—è —Å—Ö–µ–º–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ (Telegram)                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BOT (app/bot/main.py) ‚Äî aiogram 3, FSM –≤ Redis                                  ‚îÇ
‚îÇ  ‚Ä¢ SecurityMiddleware: –±–∞–Ω/—Å—É—Å–ø–µ–Ω–¥/rate limit –ø–æ User + Redis                   ‚îÇ
‚îÇ  ‚Ä¢ SubscriptionMiddleware: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª (SUBSCRIPTION_CHANNEL)      ‚îÇ
‚îÇ  ‚Ä¢ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ ‚Üí storage_base_path/inputs/ (file_id.jpg –∏ —Ç.–¥.)              ‚îÇ
‚îÇ  ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ Job –≤ –ë–î, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏ –≤ Celery                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº           ‚ñº           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PostgreSQL   ‚îÇ ‚îÇ Redis         ‚îÇ ‚îÇ Celery       ‚îÇ
‚îÇ (trends DB)  ‚îÇ ‚îÇ FSM, rate     ‚îÇ ‚îÇ broker+result‚îÇ
‚îÇ              ‚îÇ ‚îÇ limit, idempot‚îÇ ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚ñ≤                                ‚îÇ
        ‚îÇ                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  API (FastAPI, app/main.py)                                                        ‚îÇ
‚îÇ  ‚Ä¢ /health, /ready, /metrics                                                       ‚îÇ
‚îÇ  ‚Ä¢ /admin/auth/* ‚Äî JWT –ª–æ–≥–∏–Ω/me                                                    ‚îÇ
‚îÇ  ‚Ä¢ /trends ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤                                    ‚îÇ
‚îÇ  ‚Ä¢ /admin/* ‚Äî –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∞–¥–º–∏–Ω–∫–∏ (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: get_current_user)               ‚îÇ
‚îÇ  ‚Ä¢ /admin-ui/* ‚Äî —Å—Ç–∞—Ä—ã–µ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã (Jinja2)                                    ‚îÇ
‚îÇ  ‚Ä¢ Playground: –ø—Ä–æ–≥–æ–Ω –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è —Ç—Ä–µ–Ω–¥–æ–≤                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  WORKER (Celery) ‚Äî app.workers.tasks.generation_v2.generate_image               ‚îÇ
‚îÇ  ‚Ä¢ –ß–∏—Ç–∞–µ—Ç Job –∏–∑ –ë–î ‚Üí Trend, —Å—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç ‚Üí ImageProvider ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª     ‚îÇ
‚îÇ  ‚Ä¢ TelegramClient (httpx): editMessageText / deleteMessage / sendPhoto          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  IMAGE PROVIDER (—Ñ–∞–±—Ä–∏–∫–∞ –ø–æ IMAGE_PROVIDER / AppSettings)                        ‚îÇ
‚îÇ  ‚Ä¢ gemini ‚Üí GeminiNanaBananaProvider (generativelanguage.googleapis.com)       ‚îÇ
‚îÇ  ‚Ä¢ openai, huggingface, replicate, google_vertex ‚Äî –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. –ü–æ—Ç–æ–∫ ¬´–°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ¬ª (–æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π)

### 2.1. –í—Ö–æ–¥ –≤ –±–æ—Ç–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´üî• –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ¬ª –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ —Å—Ä–∞–∑—É.
2. **–°–æ—Å—Ç–æ—è–Ω–∏–µ FSM:** `BotStates.waiting_for_photo`.
3. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (`SUBSCRIPTION_CHANNEL_USERNAME`), **SubscriptionMiddleware** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É; –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É ¬´–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è¬ª –∏ –Ω–µ –ø—É—Å–∫–∞–µ—Ç –¥–∞–ª—å—à–µ.

### 2.2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **—Ñ–æ—Ç–æ** (–∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º).
2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫: `handle_photo_step1` / `handle_photo_as_document_step1`.
3. **–î–∞–Ω–Ω—ã–µ:**
   - `bot.get_file(photo.file_id)` ‚Üí `bot.download_file(..., local_path)`.
   - `local_path` = `{storage_base_path}/inputs/{file_id}.jpg` (–∏–ª–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞).
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞: –µ—Å–ª–∏ —Ñ–∞–π–ª > `MAX_FILE_SIZE_MB` ‚Äî –æ—Ç–∫–∞–∑, —Ñ–∞–π–ª —É–¥–∞–ª—è–µ—Ç—Å—è.
5. **User:** `UserService.get_or_create_user(telegram_id, username, first_name, last_name)` ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`.
6. **–¢—Ä–µ–Ω–¥—ã:** `TrendService.list_active()` ‚Äî —Ç–æ–ª—å–∫–æ `enabled=true`, –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
7. **FSM:** `state.update_data(photo_file_id=..., photo_local_path=local_path)`, `state.set_state(waiting_for_trend)`.
8. –û—Ç–≤–µ—Ç: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ç—Ä–µ–Ω–¥–∞ (–∏–ª–∏ –ø—Ä–∏ deep link ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É —Ñ–æ—Ä–º–∞—Ç–∞).

### 2.3. –í—ã–±–æ—Ä —Ç—Ä–µ–Ω–¥–∞ –∏–ª–∏ ¬´–°–≤–æ—è –∏–¥–µ—è¬ª

1. **–¢—Ä–µ–Ω–¥ –ø–æ –∫–Ω–æ–ø–∫–µ:** `select_trend_or_idea` (callback `trend:{id}`).
   - `selected_trend_id`, `selected_trend_name` –ø–∏—à—É—Ç—Å—è –≤ state.
   - –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç—Ä–µ–Ω–¥ (–Ω–µ `custom`) ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –≤ `waiting_for_format`.
   - –ï—Å–ª–∏ ¬´üí° –°–≤–æ—è –∏–¥–µ—è¬ª (`trend:custom`) ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –≤ `waiting_for_custom_prompt`.
2. **–°–≤–æ—è –∏–¥–µ—è:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç ‚Üí `handle_custom_prompt` ‚Üí `state.update_data(custom_prompt=...)` ‚Üí `waiting_for_format`.
3. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞: `format_keyboard()` (1:1, 16:9, 4:3, 9:16, 3:4) ‚Üí `IMAGE_FORMATS[format_key]` –¥–∞—ë—Ç —Ä–∞–∑–º–µ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä `1024x1024`.

### 2.4. –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

1. Callback `format:{key}` ‚Üí **select_format_and_generate**.
2. –ò–∑ state: `photo_file_id`, `photo_local_path`, `selected_trend_id`, `custom_prompt` (–µ—Å–ª–∏ –±—ã–ª–∞ —Å–≤–æ—è –∏–¥–µ—è).
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ `input_local_paths`.
4. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** `IdempotencyStore().check_and_set("job:{chat_id}:{msg_id}:{format_key}")` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è.
5. **–ö–≤–æ—Ç—ã –∏ —Ç–æ–∫–µ–Ω—ã:**
   - –ï—Å–ª–∏ –Ω–µ copy-flow: `UserService.try_use_free_generation(user)` (–ª–∏–º–∏—Ç –∏–∑ `SecuritySettings.free_generations_per_user`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3).
   - –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–≤–æ—Ç–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ `user_service.can_reserve(user, generation_cost_tokens)` –∏ `user_service.hold_tokens(user, job_id, tokens)` (—Ä–µ–∑–µ—Ä–≤ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–¥ –∑–∞–¥–∞—á—É).
6. **–°–æ–∑–¥–∞–Ω–∏–µ Job:**
   - `JobService.create_job(user_id, trend_id, input_file_ids=[photo_file_id], input_local_paths=[photo_local_path], reserved_tokens=..., used_free_quota=..., used_copy_quota=..., job_id=..., custom_prompt=..., image_size=...)`
   - –í –ë–î: `jobs` ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `CREATED`, `input_local_paths` = –ø—É—Ç–∏ –∫ —Å–∫–∞—á–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º –Ω–∞ –¥–∏—Å–∫–µ –≤–æ—Ä–∫–µ—Ä–∞/–æ–±—â–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
7. **Audit:** `AuditService.log(actor_type="user", action="job_created", entity_type="job", entity_id=job_id, payload={...})`.
8. –°–æ–æ–±—â–µ–Ω–∏–µ ¬´‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...¬ª –∏ **–æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏ –≤ Celery:**
   - `celery_app.send_task("app.workers.tasks.generation_v2.generate_image", args=[job_id], kwargs={status_chat_id, status_message_id})`.
9. State –æ—á–∏—â–∞–µ—Ç—Å—è.

---

## 3. –ü–æ—Ç–æ–∫ ¬´–°–¥–µ–ª–∞—Ç—å —Ç–∞–∫—É—é –∂–µ¬ª (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∏–ª—è)

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ¬´üîÑ –°–¥–µ–ª–∞—Ç—å —Ç–∞–∫—É—é –∂–µ¬ª ‚Üí **start_copy_flow** ‚Üí state: `waiting_for_reference_photo`.
2. **–†–µ—Ñ–µ—Ä–µ–Ω—Å (–æ–±—Ä–∞–∑–µ—Ü —Å—Ç–∏–ª—è):** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ/–¥–æ–∫—É–º–µ–Ω—Ç ‚Üí **handle_reference_photo** / **handle_reference_photo_as_document**:
   - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ `inputs/ref_{file_id}.jpg`.
   - **Vision-–∞–Ω–∞–ª–∏–∑:** `analyze_reference_image(local_path)` (OpenAI Vision –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –∏–∑ `copy_style_settings`: system_prompt, user_prompt, model).
   - –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∏–ª—è ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ state –∫–∞–∫ **copy_prompt**.
   - –¢–∞–∫–∂–µ –≤ state: `reference_path=local_path`, `copy_photos_count=1` (–∏–ª–∏ 2 –¥–ª—è –¥–≤—É—Ö –ª–∏—Ü).
3. –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–∏—Ü (1 –∏–ª–∏ 2) ‚Üí –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –¥–≤—É—Ö ¬´—Å–≤–æ–∏—Ö¬ª —Ñ–æ—Ç–æ.
4. –ö–∞–∂–¥–æ–µ —Å–≤–æ—ë —Ñ–æ—Ç–æ —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ `inputs/{file_id}.jpg`, –≤ state –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ `copy_photos_received` —Å `{file_id, path}`.
5. –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Ñ–æ—Ä–º–∞—Ç—É –≤ state –µ—Å—Ç—å: `copy_prompt`, `reference_path`, `copy_photos_received`, **selected_trend_id=TREND_CUSTOM_ID** ("custom"), **custom_prompt=copy_prompt**.
6. –í **select_format_and_generate** –¥–ª—è copy:
   - `input_file_ids` = `["ref"] + [file_id, ...]` –ø–æ —Ñ–æ—Ç–æ, `input_local_paths` = `[reference_path] + [path, ...]`.
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–≤–æ—Ç–∞ **copy:** `user_service.try_use_copy_generation(user)` (–ª–∏–º–∏—Ç –∏–∑ `copy_generations_per_user`).
7. Job —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å **trend_id="custom"** –∏ **custom_prompt=copy_prompt**.  
   **–í–∞–∂–Ω–æ:** –≤ –≤–æ—Ä–∫–µ—Ä–µ `_build_prompt_for_job` —Å–µ–π—á–∞—Å **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç** `job.custom_prompt`; –ø—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ —Ç—Ä–µ–Ω–¥–∞. –î–ª—è —Ä–∞–±–æ—Ç—ã ¬´–°–≤–æ—è –∏–¥–µ—è¬ª/¬´–°–¥–µ–ª–∞—Ç—å —Ç–∞–∫—É—é –∂–µ¬ª –Ω—É–∂–µ–Ω –ª–∏–±–æ —Ç—Ä–µ–Ω–¥ —Å id `"custom"` –≤ –ë–î (—Å –ø–æ–¥—Ö–æ–¥—è—â–∏–º system_prompt/scene_prompt), –ª–∏–±–æ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Ä–∫–µ—Ä–∞: –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å `job.custom_prompt` –≤ –±–ª–æ–∫ [SCENE] –ø—Ä–∏ trend_id="custom".

---

## 4. –í–æ—Ä–∫–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (generation_v2)

### 4.1. –í—Ö–æ–¥

- Celery –≤—ã–∑—ã–≤–∞–µ—Ç `generate_image(job_id, status_chat_id=..., status_message_id=...)`.

### 4.2. –ß—Ç–µ–Ω–∏–µ Job –∏ Trend

- `JobService(db).get(job_id)`.
- `TrendService(db).get(job.trend_id)` ‚Äî —Ç—Ä–µ–Ω–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω; –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å—Ç–∞—Ç—É—Å FAILED, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ¬´–¢—Ä–µ–Ω–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω¬ª.

### 4.3. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ (_build_prompt_for_job)

–ò—Å—Ç–æ—á–Ω–∏–∫–∏:

- **GenerationPromptSettings** (—Ç–∞–±–ª–∏—Ü–∞ `generation_prompt_settings`, –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å): –±–ª–æ–∫–∏ [INPUT], [TASK], [IDENTITY TRANSFER], [SAFETY] –∏ –¥–µ—Ñ–æ–ª—Ç—ã (default_model, default_size, default_format, default_temperature, default_image_size_tier).
- **TransferPolicy** (scope=trends): identity_rules_text, composition_rules_text, avoid_default_items ‚Üí –±–ª–æ–∫–∏ [IDENTITY TRANSFER], [COMPOSITION], [AVOID].
- **Trend:** scene_prompt (–∏–ª–∏ system_prompt), style_preset, negative_scene, negative_prompt ‚Üí [SCENE], [STYLE], [AVOID], –Ω–µ–≥–∞—Ç–∏–≤.

**–î–≤–∞ —Ä–µ–∂–∏–º–∞:**

1. **–£ —Ç—Ä–µ–Ω–¥–∞ –µ—Å—Ç—å prompt_sections (Playground):** –ø—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ —Å–µ–∫—Ü–∏–π (sorted by order), –±–µ–∑ –±–ª–æ–∫–æ–≤ –º–∞—Å—Ç–µ—Ä–∞; –º–æ–¥–µ–ª—å/—Ä–∞–∑–º–µ—Ä –º–æ–≥—É—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –∏–∑ —Ç—Ä–µ–Ω–¥–∞ (prompt_model, prompt_size).
2. **–ò–Ω–∞—á–µ ‚Äî –µ–¥–∏–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –±–ª–æ–∫–æ–≤:**  
   [INPUT] ‚Üí [TASK] ‚Üí [IDENTITY TRANSFER] ‚Üí [COMPOSITION] ‚Üí [SCENE] ‚Üí [STYLE] ‚Üí [AVOID] ‚Üí [SAFETY] ‚Üí [OUTPUT] (size=..., format=...).

–ò—Ç–æ–≥: `(prompt_text, negative_prompt, model, size)`.

### 4.4. –í—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

- `input_image_path = job.input_local_paths[0]` (–µ—Å–ª–∏ –µ—Å—Ç—å –∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).
- –í –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ Gemini: –≤ `contents[0].parts` —Å–Ω–∞—á–∞–ª–∞ –∏–¥—ë—Ç **text** (prompt + –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ "Avoid: ..."), –∑–∞—Ç–µ–º –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ ‚Äî **inlineData** (base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è). –¢–æ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –∫ API: –æ–¥–∏–Ω user turn —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.

### 4.5. –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∏ –∑–∞–ø—Ä–æ—Å

- –ü—Ä–æ–≤–∞–π–¥–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è: `AppSettingsService.get_effective_provider(settings)` –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `IMAGE_PROVIDER` (gemini).
- `ImageProviderFactory.create_from_settings(settings, provider)`.
- –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è **ImageGenerationRequest** (prompt, model, size, negative_prompt, input_image_path, temperature, seed, image_size_tier).
- –í—ã–∑–æ–≤ **generate_with_retry(provider, request, ...)** (runner —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –∏ circuit breaker).

### 4.6. –û—Ç–≤–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

- **ImageGenerationResponse** —Å `image_content` (bytes).
- –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è: `{storage_base_path}/outputs/{job_id}.png` (–∏–ª–∏ .jpg –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ).
- `JobService.set_output(job, output_path)`, `JobService.set_status(job, "SUCCEEDED")`.
- –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ **–Ω–µ** –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `apply_watermark` –∏ **–Ω–µ** –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è `job.is_preview` –∏ `job.output_path_original`. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—Å–µ–≥–¥–∞ —É—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª (–±–µ–∑ watermark). –õ–æ–≥–∏–∫–∞ ¬´—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞ —Ç–æ–∫–µ–Ω—ã/Stars¬ª –≤ –±–æ—Ç–µ –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ `is_preview` –∏ `output_path_original` ‚Äî –ø–æ–∫–∞ –æ–Ω–∏ –Ω–µ –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤–æ—Ä–∫–µ—Ä–æ–º, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ¬´–æ—Ä–∏–≥–∏–Ω–∞–ª–∞¬ª –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–µ –±—É–¥–µ—Ç –¥–∞–≤–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ —Ñ–∞–π–ª–∞.

### 4.7. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è ¬´‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...¬ª (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω status_message_id).
- **TelegramClient.send_photo(status_chat_id, output_path)** ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —á–∞—Ç.
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: edit —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–∏–ª–∏ send_message), —Å—Ç–∞—Ç—É—Å Job = FAILED, error_code.

---

## 5. –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ

| –î–∞–Ω–Ω—ã–µ | –ì–¥–µ |
|--------|-----|
| –§–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—Ö–æ–¥) | –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞: `{storage_base_path}/inputs/` (–ø–æ file_id –∏–ª–∏ ref_..., regen_..., retry_...). |
| –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | `{storage_base_path}/outputs/{job_id}.png` (–∏–ª–∏ .jpg). |
| –ß–µ–∫–∏ (–æ–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–º) | `{storage_base_path}/receipts/` + –∑–∞–ø–∏—Å—å –≤ `bank_transfer_receipt_log`. |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Ç—Ä–µ–Ω–¥—ã, –∑–∞–¥–∞—á–∏, –ø–ª–∞—Ç–µ–∂–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | PostgreSQL (—Ç–∞–±–ª–∏—Ü—ã: users, trends, themes, jobs, payments, packs, generation_prompt_settings, transfer_policy, security_settings, copy_style_settings, telegram_message_templates, app_settings, bank_transfer_settings, audit_log –∏ –¥—Ä.). |
| FSM –±–æ—Ç–∞, rate limit, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | Redis (–∫–ª—é—á–∏ –ø–æ telegram_id, —á–∞—Å—É, job key). |
| –û—á–µ—Ä–µ–¥—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–¥–∞—á | Redis (Celery broker + result backend). |

---

## 6. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è)

- **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–º–∞—Å—Ç–µ—Ä):** –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ `generation_prompt_settings`: [INPUT], [TASK], [IDENTITY TRANSFER], [SAFETY] + default_model, default_size, default_format, default_temperature, default_image_size_tier, default_aspect_ratio. –í –∞–¥–º–∏–Ω–∫–µ: ¬´–ü—Ä–æ–º–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏¬ª / Master prompt.
- **Transfer policy:** –¥–≤–µ –∑–∞–ø–∏—Å–∏ –≤ `transfer_policy` (scope=global, scope=trends). –î–ª—è —Ç—Ä–µ–Ω–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è: identity_rules_text, composition_rules_text, avoid_default_items. –ê–¥–º–∏–Ω–∫–∞: ¬´–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞¬ª.
- **–¢—Ä–µ–Ω–¥:** –≤ `trends` ‚Äî scene_prompt, system_prompt (legacy), negative_prompt, negative_scene, style_preset, prompt_sections (Playground), prompt_model, prompt_size, prompt_temperature, prompt_seed, prompt_image_size_tier. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ prompt_sections –≤–æ—Ä–∫–µ—Ä —Å–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–º–ø—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –Ω–∏—Ö.
- **¬´–°–¥–µ–ª–∞—Ç—å —Ç–∞–∫—É—é –∂–µ¬ª:** —Ç–∞–±–ª–∏—Ü–∞ `copy_style_settings` ‚Äî –ø—Ä–æ–º–ø—Ç—ã –∏ –º–æ–¥–µ–ª—å –¥–ª—è Vision-–∞–Ω–∞–ª–∏–∑–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞; –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî generation_* –ø–æ–ª—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–ø—Ä–µ—Ñ–∏–∫—Å, –Ω–µ–≥–∞—Ç–∏–≤, safety, —Ä–∞–∑–º–µ—Ä, –º–æ–¥–µ–ª—å). –í –≤–æ—Ä–∫–µ—Ä–µ –¥–ª—è trend_id="custom" —Å–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–Ω–¥ (—Å–º. –ø. 4.3 –∏ 3); custom_prompt –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è.

---

## 7. –û–ø–ª–∞—Ç–∞ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–∫—Ä–∞—Ç–∫–æ)

- **–ü–∞–∫–µ—Ç—ã:** —Ç–∞–±–ª–∏—Ü–∞ `packs` (tokens, stars_price). –ü–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ Telegram Stars (PreCheckoutQuery ‚Üí successful_payment) –∏–ª–∏ —á–µ—Ä–µ–∑ ¬´–ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É¬ª (—Ñ–ª–æ—É —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —á–µ–∫–∞ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Å—É–º–º—ã).
- **PaymentService:** —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞, –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, refund.
- –í –±–æ—Ç–µ –ø–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏ ¬´–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞ —Ç–æ–∫–µ–Ω—ã¬ª / ¬´–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞ Stars¬ª. –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `job.is_preview` –∏ `job.output_path_original`; —Ç–∞–∫ –∫–∞–∫ –≤–æ—Ä–∫–µ—Ä –∏—Ö –Ω–µ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç, —Å–µ–π—á–∞—Å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ –º–µ–Ω—è–µ—Ç —Ñ–∞–π–ª (–º–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ—Ä–∫–µ—Ä: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª, –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å watermark –Ω–∞ –∫–æ–ø–∏—é, –≤ Job –ø–∏—Å–∞—Ç—å –æ–±–∞ –ø—É—Ç–∏ –∏ is_preview=true).

---

## 8. –ê–¥–º–∏–Ω–∫–∞ (React) –∏ API

- –§—Ä–æ–Ω—Ç: `admin-frontend`, —Ö–æ–¥–∏—Ç –Ω–∞ `ADMIN_UI_API_BASE` (–ø–æ—Ä—Ç 8000). –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: JWT (`/admin/auth/login`), —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ/cookie.
- –í—Å–µ –Ω—É–∂–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ `app/api/routes/admin.py`: security, transfer-policy, master-prompt, settings/env, settings/app, users, telegram-messages, telemetry, bank-transfer, payments, packs, themes, trends, audit, broadcast, jobs, copy-style, cleanup.
- –¢—Ä–µ–Ω–¥—ã: CRUD, –∑–∞–≥—Ä—É–∑–∫–∞ example/style-reference, playground-config, prompt-preview. Playground (—Ç–µ—Å—Ç –ø—Ä–æ–º–ø—Ç–æ–≤) ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–æ—É—Ç –≤ `playground.py`.

---

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ—Ç—Ä–∞–∂–∞–µ—Ç **—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–¥–∞** (–ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É) –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–æ–∫ (custom_prompt –≤ –≤–æ—Ä–∫–µ—Ä–µ, watermark/original –≤ generation_v2, –∏ —Ç.–¥.).
