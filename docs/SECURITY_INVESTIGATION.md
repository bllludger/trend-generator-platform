# Отчёт по расследованию безопасности (03.02.2026)

## Критические уязвимости

### 1. PostgreSQL открыт в интернет (порт 5432)
- **Проблема:** База доступна на 0.0.0.0:5432 — любой может подключиться
- **Риск:** SQL-инъекции, RCE через `COPY FROM PROGRAM`, кража данных, майнеры (атака уже была — см. логи db-1)
- **Пароль:** Был слабый `trends`

### 2. Redis открыт без пароля (порт 6379)
- **Проблема:** Redis на 0.0.0.0:6379 без аутентификации
- **Риск:** Кража сессий, данных Celery, возможность записи (в т.ч. RCE через модули)

### 3. Слабые/утечшие пароли в .env
- POSTGRES_PASSWORD=trends
- ADMIN_API_KEY — короткий, в логах
- ADMIN_UI_PASSWORD — в plaintext
- API ключи OpenAI, Gemini в репозитории

### 4. Cleanup API на 0.0.0.0:8001
- /health доступен без авторизации
- Основной /cleanup/run защищён X-Admin-Key, но порт открыт

## Карта портов (до исправления)

| Порт | Сервис       | Слушает      | Доступность        |
|------|--------------|--------------|--------------------|
| 3000 | Admin UI     | 0.0.0.0      | Интернет (админка) |
| 5432 | PostgreSQL   | 0.0.0.0      | Интернет (ОПАСНО)  |
| 6379 | Redis        | 0.0.0.0      | Интернет (ОПАСНО)  |
| 8000 | Main API     | 0.0.0.0      | Интернет           |
| 8001 | Cleanup      | 0.0.0.0      | Интернет           |

## Админка

- **React-админка:** http://45.14.245.43:3000 (порт 3000)
- **API админки:** http://45.14.245.43:8000/admin/* (требует X-Admin-Key или JWT)
- **Старая Jinja-админка:** http://45.14.245.43:8000/admin-ui/* (session)
- **Логин:** /admin/auth/login (JWT) или /admin-ui/login (session)

## Принятые меры

1. **Пароли заменены** — все секреты перегенерированы
2. **PostgreSQL** — привязан к 127.0.0.1:5432 (только localhost)
3. **Redis** — добавлен пароль, привязан к 127.0.0.1:6379
4. **Cleanup** — привязан к 127.0.0.1:8001
5. **API и Admin UI** — остаются на 0.0.0.0 (нужны для бота и веб-доступа)

## Рекомендации

- [ ] Поставить nginx/traefik, открыть только 80/443
- [ ] Включить HTTPS
- [ ] Ротировать TELEGRAM_BOT_TOKEN (если считаете скомпрометированным)
- [ ] Ротировать OPENAI_API_KEY, GEMINI_API_KEY (если в git)
- [ ] Использовать ADMIN_UI_PASSWORD_HASH вместо plaintext
- [ ] Добавить fail2ban для SSH и /admin/auth/login
