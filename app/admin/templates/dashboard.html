{% extends "base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <h2>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="grid">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
            <div class="value" id="users-total">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</h3>
            <div class="value" id="users-subscribed">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h3>–í—Å–µ–≥–æ –∑–∞–¥–∞—á</h3>
            <div class="value" id="jobs-total">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <h3>–ó–∞–¥–∞—á –∑–∞ 24—á</h3>
            <div class="value" id="jobs-window">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <h3>–í –æ—á–µ—Ä–µ–¥–∏</h3>
            <div class="value" id="queue-length">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
            <h3>–£—Å–ø–µ—à–Ω—ã—Ö</h3>
            <div class="value" id="jobs-succeeded">-</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>üìà –°—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á</h2>
    <div id="jobs-by-status"></div>
</div>

<div class="card">
    <h2>üé® –¢–æ–ø —Ç—Ä–µ–Ω–¥–æ–≤ (–∑–∞ 24—á)</h2>
    <div id="trends-top"></div>
</div>

<div class="card">
    <h2>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
    <div class="flex" style="gap: 1rem; flex-wrap: wrap;">
        <a href="/admin-ui/trends/new" class="btn btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å —Ç—Ä–µ–Ω–¥</a>
        <a href="/admin-ui/users" class="btn">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        <a href="/admin-ui/jobs?status=FAILED" class="btn btn-danger">‚ùå –û—à–∏–±–∫–∏</a>
        <a href="/admin-ui/jobs?status=RUNNING" class="btn btn-warning">‚è≥ –í —Ä–∞–±–æ—Ç–µ</a>
        <a href="/admin-ui/cleanup" class="btn btn-secondary">üßπ –û—á–∏—Å—Ç–∫–∞</a>
    </div>
</div>

<div class="card">
    <h2>üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <h3>–û—à–∏–±–æ–∫ –∑–∞ 24—á</h3>
            <div class="value" id="jobs-failed">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
            <h3>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</h3>
            <div class="value" id="success-rate">-</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
            <h3>–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</h3>
            <div class="value" id="avg-per-day">-</div>
        </div>
    </div>
</div>

<script>
async function loadDashboard() {
    try {
        const resp = await fetch('/admin/telemetry?window_hours=24', {
            headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
        });
        const data = await resp.json();
        
        document.getElementById('users-total').textContent = data.users_total || 0;
        document.getElementById('users-subscribed').textContent = data.users_subscribed || 0;
        document.getElementById('jobs-total').textContent = data.jobs_total || 0;
        document.getElementById('jobs-window').textContent = data.jobs_window || 0;
        document.getElementById('queue-length').textContent = data.queue_length || 0;
        
        const succeeded = data.jobs_by_status?.SUCCEEDED || 0;
        const failed = data.jobs_by_status?.FAILED || 0;
        const running = data.jobs_by_status?.RUNNING || 0;
        const created = data.jobs_by_status?.CREATED || 0;
        
        document.getElementById('jobs-succeeded').textContent = succeeded;
        document.getElementById('jobs-failed').textContent = failed;
        
        // Success rate
        const total = succeeded + failed;
        const successRate = total > 0 ? ((succeeded / total) * 100).toFixed(1) : 0;
        document.getElementById('success-rate').textContent = successRate + '%';
        
        // Average per day
        const avgPerDay = data.jobs_window ? (data.jobs_window / 1).toFixed(0) : 0;
        document.getElementById('avg-per-day').textContent = avgPerDay;
        
        // Jobs by status
        const statusDiv = document.getElementById('jobs-by-status');
        statusDiv.innerHTML = '';
        if (data.jobs_by_status) {
            const table = document.createElement('table');
            table.innerHTML = '<tr><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th></tr>';
            for (const [status, count] of Object.entries(data.jobs_by_status)) {
                const row = table.insertRow();
                row.insertCell().textContent = status;
                row.insertCell().textContent = count;
            }
            statusDiv.appendChild(table);
        }
        
        // Top trends
        const trendsDiv = document.getElementById('trends-top');
        trendsDiv.innerHTML = '';
        if (data.trend_analytics_window) {
            const table = document.createElement('table');
            table.innerHTML = '<tr><th>–¢—Ä–µ–Ω–¥</th><th>–í—Å–µ–≥–æ</th><th>–£—Å–ø–µ—à–Ω–æ</th><th>–û—à–∏–±–æ–∫</th><th>–í—ã–±—Ä–∞–Ω–æ</th></tr>';
            data.trend_analytics_window.slice(0, 10).forEach(t => {
                const row = table.insertRow();
                row.insertCell().innerHTML = `${t.emoji} ${t.name}`;
                row.insertCell().textContent = t.jobs_window || 0;
                row.insertCell().textContent = t.succeeded_window || 0;
                row.insertCell().textContent = t.failed_window || 0;
                row.insertCell().textContent = t.selected_window || 0;
            });
            trendsDiv.appendChild(table);
        }
    } catch (e) {
        console.error('Failed to load dashboard:', e);
    }
}

loadDashboard();
setInterval(loadDashboard, 30000); // Refresh every 30s
</script>
{% endblock %}
