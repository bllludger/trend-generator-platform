{% extends "base.html" %}

{% block title %}–ó–∞–¥–∞—á–∏ - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <div class="flex-between">
        <h2>‚öôÔ∏è –ó–∞–¥–∞—á–∏</h2>
        <div class="flex">
            <select id="status-filter" onchange="loadJobs()" style="padding: 0.5rem;">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="CREATED">–°–æ–∑–¥–∞–Ω–∞</option>
                <option value="RUNNING">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</option>
                <option value="SUCCEEDED">–£—Å–ø–µ—à–Ω–æ</option>
                <option value="FAILED">–û—à–∏–±–∫–∞</option>
            </select>
            <input type="text" class="search-box" id="telegram-search" placeholder="Telegram ID..." 
                   onkeyup="if(event.key==='Enter') loadJobs()">
            <button onclick="exportJobs()" class="btn btn-secondary">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Telegram ID</th>
                <th>–¢—Ä–µ–Ω–¥</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–¢–æ–∫–µ–Ω—ã</th>
                <th>–û—à–∏–±–∫–∞</th>
                <th>–°–æ–∑–¥–∞–Ω–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="jobs-table">
            <tr><td colspan="8">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
    </table>
    
    <div class="pagination" id="pagination"></div>
</div>

<script>
let currentPage = 1;
let currentStatus = '';
let currentTelegram = '';

function loadJobs(page = 1, status = '', telegramId = '') {
    currentPage = page;
    currentStatus = status;
    currentTelegram = telegramId;
    
    const params = new URLSearchParams({ page, page_size: 20 });
    if (status) params.append('status', status);
    if (telegramId) params.append('telegram_id', telegramId);
    
    fetch(`/admin/jobs?${params}`, {
        headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
    })
    .then(r => r.json())
    .then(data => {
        const tbody = document.getElementById('jobs-table');
        tbody.innerHTML = '';
        
        if (data.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            return;
        }
        
        data.items.forEach(job => {
            const row = tbody.insertRow();
            row.insertCell().innerHTML = `<code style="font-size: 0.8rem;">${job.job_id.substring(0, 8)}...</code>`;
            row.insertCell().textContent = job.telegram_id || '-';
            row.insertCell().textContent = job.trend_name || job.trend_id.substring(0, 8);
            
            const statusCell = row.insertCell();
            const statusBadge = {
                'CREATED': '<span class="badge badge-info">–°–æ–∑–¥–∞–Ω–∞</span>',
                'RUNNING': '<span class="badge badge-warning">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</span>',
                'SUCCEEDED': '<span class="badge badge-success">–£—Å–ø–µ—à–Ω–æ</span>',
                'FAILED': '<span class="badge badge-error">–û—à–∏–±–∫–∞</span>'
            }[job.status] || job.status;
            statusCell.innerHTML = statusBadge;
            
            row.insertCell().textContent = job.reserved_tokens;
            row.insertCell().textContent = job.error_code || '-';
            row.insertCell().textContent = new Date(job.created_at).toLocaleString('ru');
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `
                <a href="/admin-ui/jobs/${job.job_id}" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">–î–µ—Ç–∞–ª–∏</a>
            `;
        });
        
        // Pagination
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        if (data.pages > 1) {
            for (let i = 1; i <= data.pages; i++) {
                const span = document.createElement(i === page ? 'span' : 'a');
                span.textContent = i;
                span.className = i === page ? 'current' : '';
                if (i !== page) {
                    span.href = '#';
                    span.onclick = (e) => { e.preventDefault(); loadJobs(i, currentStatus, currentTelegram); };
                }
                pagination.appendChild(span);
            }
        }
    })
    .catch(e => {
        console.error('Failed to load jobs:', e);
        document.getElementById('jobs-table').innerHTML = '<tr><td colspan="8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    });
}

document.getElementById('telegram-search').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
        loadJobs(1, currentStatus, e.target.value);
    }
});

function exportJobs() {
    const params = new URLSearchParams({ page: 1, page_size: 1000 });
    if (currentStatus) params.append('status', currentStatus);
    if (currentTelegram) params.append('telegram_id', currentTelegram);
    
    fetch(`/admin/jobs?${params}`, {
        headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
    })
    .then(r => r.json())
    .then(data => {
        let csv = 'ID,Telegram ID,–¢—Ä–µ–Ω–¥,–°—Ç–∞—Ç—É—Å,–¢–æ–∫–µ–Ω—ã,–û—à–∏–±–∫–∞,–°–æ–∑–¥–∞–Ω–∞\n';
        data.items.forEach(job => {
            csv += `${job.job_id},"${job.telegram_id || ''}","${job.trend_name || job.trend_id}",${job.status},${job.reserved_tokens},"${job.error_code || ''}","${new Date(job.created_at).toLocaleString('ru')}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `jobs_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    })
    .catch(e => alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message));
}

loadJobs();
</script>
{% endblock %}
