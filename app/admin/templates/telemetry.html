{% extends "base.html" %}

{% block title %}–¢–µ–ª–µ–º–µ—Ç—Ä–∏—è - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <div class="flex-between">
        <h2>üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è</h2>
        <div class="flex">
            <select id="window-select" onchange="loadTelemetry()" style="padding: 0.5rem;">
                <option value="1">–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å</option>
                <option value="24" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞</option>
                <option value="168">–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è</option>
                <option value="720">–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
            </select>
            <button onclick="exportTelemetry()" class="btn btn-secondary">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        </div>
    </div>
    <div class="grid" style="margin-top: 1rem;">
      <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ–≥–æ</h3>
        <div class="value">{{ data.users_total or 0 }}</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h3>–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</h3>
        <div class="value">{{ data.users_subscribed or 0 }}</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <h3>Jobs –≤—Å–µ–≥–æ</h3>
        <div class="value">{{ data.jobs_total or 0 }}</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <h3>Jobs –∑–∞ –æ–∫–Ω–æ</h3>
        <div class="value">{{ data.jobs_window or 0 }}</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
        <h3>–í –æ—á–µ—Ä–µ–¥–∏</h3>
        <div class="value">{{ data.queue_length or 0 }}</div>
      </div>
    </div>
</div>

<div class="card">
    <h3>üìä Jobs –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
    <table>
        <thead>
            <tr><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th></tr>
        </thead>
        <tbody>
            {% for status, count in (data.jobs_by_status or {}).items() %}
            <tr>
                <td>{{ status }}</td>
                <td>{{ count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>üé® –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç—Ä–µ–Ω–¥–∞–º</h3>
    <table>
        <thead>
            <tr>
                <th>–¢—Ä–µ–Ω–¥</th>
                <th>–í—Å–µ–≥–æ</th>
                <th>–£—Å–ø–µ—à–Ω–æ</th>
                <th>–û—à–∏–±–æ–∫</th>
                <th>–í—ã–±—Ä–∞–Ω–æ</th>
                <th>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</th>
            </tr>
        </thead>
        <tbody>
            {% for trend in (data.trend_analytics_window or [])[:20] %}
            <tr>
                <td>{{ trend.emoji }} {{ trend.name }}</td>
                <td>{{ trend.jobs_window or 0 }}</td>
                <td>{{ trend.succeeded_window or 0 }}</td>
                <td>{{ trend.failed_window or 0 }}</td>
                <td>{{ trend.selected_window or 0 }}</td>
                <td>
                    {% set total = trend.jobs_window or 0 %}
                    {% set succeeded = trend.succeeded_window or 0 %}
                    {% if total > 0 %}
                        {{ ((succeeded / total) * 100) | round(1) }}%
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>üìù –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–æ–∫–µ–Ω–∞–º–∏ (–æ–∫–Ω–æ)</h3>
    <table>
        <thead>
            <tr><th>–û–ø–µ—Ä–∞—Ü–∏—è</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th></tr>
        </thead>
        <tbody>
            {% for op, count in (data.ledger_ops_window or {}).items() %}
            <tr>
                <td>{{ op }}</td>
                <td>{{ count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
let currentData = {{ data | tojson }};

function loadTelemetry() {
    const hours = document.getElementById('window-select').value;
    window.location.href = `/admin-ui/telemetry?window_hours=${hours}`;
}

function exportTelemetry() {
    const json = JSON.stringify(currentData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `telemetry_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

// Set selected option
const urlParams = new URLSearchParams(window.location.search);
const windowHours = urlParams.get('window_hours') || '24';
document.getElementById('window-select').value = windowHours;
</script>
{% endblock %}
