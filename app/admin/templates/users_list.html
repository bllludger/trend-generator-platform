{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <div class="flex-between">
        <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div class="flex">
            <input type="text" class="search-box" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ Telegram ID..." 
                   onkeyup="if(event.key==='Enter') loadUsers()">
            <button onclick="exportUsers()" class="btn btn-secondary">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Telegram ID</th>
                <th>–ë–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤</th>
                <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                <th>–ó–∞–¥–∞—á –≤—Å–µ–≥–æ</th>
                <th>–£—Å–ø–µ—à–Ω–æ</th>
                <th>–û—à–∏–±–æ–∫</th>
                <th>–°–æ–∑–¥–∞–Ω</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="users-table">
            <tr><td colspan="8">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
    </table>
    
    <div class="pagination" id="pagination"></div>
</div>

<script>
let currentPage = 1;
let currentSearch = '';

function loadUsers(page = 1, telegramId = '') {
    currentPage = page;
    currentSearch = telegramId;
    
    const params = new URLSearchParams({ page, page_size: 20 });
    if (telegramId) params.append('telegram_id', telegramId);
    
    fetch(`/admin/users?${params}`, {
        headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
    })
    .then(r => r.json())
    .then(data => {
        const tbody = document.getElementById('users-table');
        tbody.innerHTML = '';
        
        if (data.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            return;
        }
        
        data.items.forEach(user => {
            const row = tbody.insertRow();
            row.insertCell().textContent = user.telegram_id;
            row.insertCell().textContent = user.token_balance;
            row.insertCell().innerHTML = user.subscription_active 
                ? '<span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>'
                : '<span class="badge badge-error">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>';
            row.insertCell().textContent = user.jobs_count;
            row.insertCell().textContent = user.jobs_succeeded;
            row.insertCell().textContent = user.jobs_failed;
            row.insertCell().textContent = new Date(user.created_at).toLocaleString('ru');
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `
                <a href="/admin-ui/users/${user.telegram_id}" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="/admin-ui/users/${user.telegram_id}/jobs" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">–ó–∞–¥–∞—á–∏</a>
            `;
        });
        
        // Pagination
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        if (data.pages > 1) {
            for (let i = 1; i <= data.pages; i++) {
                const span = document.createElement(i === page ? 'span' : 'a');
                span.textContent = i;
                span.className = i === page ? 'current' : '';
                if (i !== page) {
                    span.href = '#';
                    span.onclick = (e) => { e.preventDefault(); loadUsers(i, currentSearch); };
                }
                pagination.appendChild(span);
            }
        }
    })
    .catch(e => {
        console.error('Failed to load users:', e);
        document.getElementById('users-table').innerHTML = '<tr><td colspan="8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    });
}

document.getElementById('search-input').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
        loadUsers(1, e.target.value);
    }
});

function exportUsers() {
    const params = new URLSearchParams({ page: 1, page_size: 1000 });
    if (currentSearch) params.append('telegram_id', currentSearch);
    
    fetch(`/admin/users?${params}`, {
        headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
    })
    .then(r => r.json())
    .then(data => {
        let csv = 'Telegram ID,–ë–∞–ª–∞–Ω—Å,–ü–æ–¥–ø–∏—Å–∫–∞,–ó–∞–¥–∞—á –≤—Å–µ–≥–æ,–£—Å–ø–µ—à–Ω–æ,–û—à–∏–±–æ–∫,–°–æ–∑–¥–∞–Ω\n';
        data.items.forEach(user => {
            csv += `${user.telegram_id},${user.token_balance},"${user.subscription_active ? '–î–∞' : '–ù–µ—Ç'}",${user.jobs_count},${user.jobs_succeeded},${user.jobs_failed},"${new Date(user.created_at).toLocaleString('ru')}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    })
    .catch(e => alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message));
}

loadUsers();
</script>
{% endblock %}
