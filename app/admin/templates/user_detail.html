{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ user.telegram_id }} - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <h2>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ user.telegram_id }}</h2>
    
    <form method="post" action="/admin-ui/users/{{ user.telegram_id }}" style="margin-top: 1rem;">
        <div class="form-group">
            <label>Telegram ID</label>
            <input type="text" value="{{ user.telegram_id }}" disabled>
        </div>
        <div class="form-group">
            <label>–ë–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤</label>
            <input type="number" name="token_balance" value="{{ user.token_balance }}" required>
        </div>
        <div class="form-group">
            <label>–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</label>
            <select name="subscription_active" required>
                <option value="true" {% if user.subscription_active %}selected{% endif %}>–î–∞</option>
                <option value="false" {% if not user.subscription_active %}selected{% endif %}>–ù–µ—Ç</option>
            </select>
        </div>
        <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a href="/admin-ui/users" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
    </form>
    {% if request.query_params.get("updated") %}
    <div class="alert alert-success" style="margin-top: 1rem;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω</div>
    {% endif %}
</div>

<div class="card">
    <div class="flex-between">
        <h3>–ó–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <div class="flex">
            <a href="/admin-ui/jobs?telegram_id={{ user.telegram_id }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">–í—Å–µ –∑–∞–¥–∞—á–∏</a>
            <button onclick="exportUserJobs()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
    </div>
    <div id="user-jobs">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="card">
    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); margin-top: 1rem;">
        <div>
            <div style="font-size: 0.9rem; color: #666;">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
            <div style="font-size: 1.5rem; font-weight: 600;" id="user-total-jobs">-</div>
        </div>
        <div>
            <div style="font-size: 0.9rem; color: #666;">–£—Å–ø–µ—à–Ω–æ</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #2e7d32;" id="user-succeeded-jobs">-</div>
        </div>
        <div>
            <div style="font-size: 0.9rem; color: #666;">–û—à–∏–±–æ–∫</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #c62828;" id="user-failed-jobs">-</div>
        </div>
        <div>
            <div style="font-size: 0.9rem; color: #666;">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
            <div style="font-size: 1.5rem; font-weight: 600;" id="user-success-rate">-</div>
        </div>
    </div>
</div>

<script>
fetch(`/admin/users/{{ user.telegram_id }}/jobs`, {
    headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
})
.then(r => r.json())
.then(jobs => {
    const div = document.getElementById('user-jobs');
    if (jobs.length === 0) {
        div.innerHTML = '<p>–ó–∞–¥–∞—á –Ω–µ—Ç</p>';
        return;
    }
    const table = document.createElement('table');
    table.innerHTML = `
        <tr>
            <th>ID</th>
            <th>–¢—Ä–µ–Ω–¥</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–¢–æ–∫–µ–Ω—ã</th>
            <th>–û—à–∏–±–∫–∞</th>
            <th>–°–æ–∑–¥–∞–Ω–∞</th>
        </tr>
    `;
    jobs.forEach(job => {
        const row = table.insertRow();
        row.insertCell().innerHTML = `<code style="font-size: 0.8rem;">${job.job_id.substring(0, 12)}...</code>`;
        row.insertCell().textContent = job.trend_id.substring(0, 12);
        row.insertCell().textContent = job.status;
        row.insertCell().textContent = job.reserved_tokens;
        row.insertCell().textContent = job.error_code || '-';
        row.insertCell().textContent = new Date().toLocaleString('ru');
    });
    div.innerHTML = '';
    div.appendChild(table);
    
    // Calculate stats
    const total = jobs.length;
    const succeeded = jobs.filter(j => j.status === 'SUCCEEDED').length;
    const failed = jobs.filter(j => j.status === 'FAILED').length;
    const successRate = total > 0 ? ((succeeded / total) * 100).toFixed(1) : 0;
    
    document.getElementById('user-total-jobs').textContent = total;
    document.getElementById('user-succeeded-jobs').textContent = succeeded;
    document.getElementById('user-failed-jobs').textContent = failed;
    document.getElementById('user-success-rate').textContent = successRate + '%';
})
.catch(e => {
    document.getElementById('user-jobs').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</p>';
});

function exportUserJobs() {
    fetch(`/admin/users/{{ user.telegram_id }}/jobs`, {
        headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
    })
    .then(r => r.json())
    .then(jobs => {
        let csv = 'ID,–¢—Ä–µ–Ω–¥,–°—Ç–∞—Ç—É—Å,–¢–æ–∫–µ–Ω—ã,–û—à–∏–±–∫–∞,–°–æ–∑–¥–∞–Ω–∞\n';
        jobs.forEach(job => {
            csv += `${job.job_id},${job.trend_id},${job.status},${job.reserved_tokens},"${job.error_code || ''}","${new Date().toLocaleString('ru')}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `user_{{ user.telegram_id }}_jobs_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    })
    .catch(e => alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message));
}
</script>
{% endblock %}
