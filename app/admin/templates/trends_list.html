{% extends "base.html" %}

{% block title %}–¢—Ä–µ–Ω–¥—ã - Admin Panel{% endblock %}

{% block content %}
<div class="flex-between">
    <h2>üé® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞–º–∏</h2>
    <a href="/admin-ui/trends/new" class="btn btn-success">+ –°–æ–∑–¥–∞—Ç—å —Ç—Ä–µ–Ω–¥</a>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>–≠–º–æ–¥–∑–∏</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–ü–æ—Ä—è–¥–æ–∫</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="trends-table">
            <tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
    </table>
</div>

<script>
async function loadTrends() {
    try {
        const resp = await fetch('/admin/trends', {
            headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
        });
        const trends = await resp.json();
        
        const tbody = document.getElementById('trends-table');
        tbody.innerHTML = '';
        
        trends.forEach(trend => {
            const row = tbody.insertRow();
            row.insertCell().textContent = trend.emoji;
            row.insertCell().textContent = trend.name;
            row.insertCell().textContent = trend.description.substring(0, 50) + '...';
            row.insertCell().textContent = trend.order_index;
            const statusCell = row.insertCell();
            statusCell.innerHTML = trend.enabled 
                ? '<span class="badge badge-success">–í–∫–ª—é—á–µ–Ω</span>'
                : '<span class="badge badge-error">–í—ã–∫–ª—é—á–µ–Ω</span>';
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `
                <a href="/admin-ui/trends/${trend.id}" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                ${trend.enabled 
                    ? `<button onclick="toggleTrend('${trend.id}', false)" class="btn btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">–í—ã–∫–ª—é—á–∏—Ç—å</button>`
                    : `<button onclick="toggleTrend('${trend.id}', true)" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">–í–∫–ª—é—á–∏—Ç—å</button>`
                }
            `;
        });
    } catch (e) {
        console.error('Failed to load trends:', e);
        document.getElementById('trends-table').innerHTML = '<tr><td colspan="6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    }
}

async function toggleTrend(id, enabled) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${enabled ? '–≤–∫–ª—é—á–∏—Ç—å' : '–≤—ã–∫–ª—é—á–∏—Ç—å'} —ç—Ç–æ—Ç —Ç—Ä–µ–Ω–¥?`)) {
        return;
    }
    
    try {
        const resp = await fetch(`/admin/trends/${id}`, {
            headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
        });
        const trend = await resp.json();
        
        trend.enabled = enabled;
        
        await fetch(`/admin/trends/${id}`, {
            method: 'PUT',
            headers: {
                'X-Admin-Key': '{{ admin_api_key or "" }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(trend)
        });
        
        loadTrends();
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

// Show success messages
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('saved') || urlParams.get('created') || urlParams.get('deleted')) {
    const msg = urlParams.get('saved') ? '–¢—Ä–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : 
                urlParams.get('created') ? '–¢—Ä–µ–Ω–¥ —Å–æ–∑–¥–∞–Ω' : 
                '–¢—Ä–µ–Ω–¥ —É–¥–∞–ª—ë–Ω';
    const alert = document.createElement('div');
    alert.className = 'alert alert-success';
    alert.textContent = msg;
    document.querySelector('.card').insertBefore(alert, document.querySelector('.card').firstChild);
    setTimeout(() => alert.remove(), 3000);
}

loadTrends();
</script>
{% endblock %}
