{% extends "base.html" %}

{% block title %}–ê—É–¥–∏—Ç - Admin Panel{% endblock %}

{% block content %}
<div class="card">
    <div class="flex-between">
        <h2>üìù –ò—Å—Ç–æ—Ä–∏—è –∞—É–¥–∏—Ç–∞</h2>
        <div class="flex">
            <select id="action-filter" onchange="loadAudit()" style="padding: 0.5rem;">
                <option value="">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
                <option value="start">–°—Ç–∞—Ä—Ç</option>
                <option value="trend_selected">–í—ã–±–æ—Ä —Ç—Ä–µ–Ω–¥–∞</option>
                <option value="job_created">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</option>
                <option value="job_succeeded">–£—Å–ø–µ—à–Ω–∞—è –∑–∞–¥–∞—á–∞</option>
                <option value="job_failed">–û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏</option>
                <option value="create">–°–æ–∑–¥–∞–Ω–∏–µ</option>
                <option value="update">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ</option>
                <option value="delete">–£–¥–∞–ª–µ–Ω–∏–µ</option>
            </select>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>–í—Ä–µ–º—è</th>
                <th>–ê–∫—Ç–æ—Ä</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                <th>–°—É—â–Ω–æ—Å—Ç—å</th>
                <th>ID</th>
                <th>–î–∞–Ω–Ω—ã–µ</th>
            </tr>
        </thead>
        <tbody id="audit-table">
            <tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
    </table>
    
    <div class="pagination" id="pagination"></div>
</div>

<script>
let currentPage = 1;
let currentAction = '';

function loadAudit(page = 1, action = '') {
    currentPage = page;
    currentAction = action;
    
    const params = new URLSearchParams({ page, page_size: 50 });
    if (action) params.append('action', action);
    
    fetch(`/admin/audit?${params}`, {
        headers: { 'X-Admin-Key': '{{ admin_api_key or "" }}' }
    })
    .then(r => r.json())
    .then(data => {
        const tbody = document.getElementById('audit-table');
        tbody.innerHTML = '';
        
        if (data.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            return;
        }
        
        data.items.forEach(log => {
            const row = tbody.insertRow();
            row.insertCell().textContent = new Date(log.created_at).toLocaleString('ru');
            row.insertCell().textContent = `${log.actor_type}${log.actor_id ? ':' + log.actor_id : ''}`;
            row.insertCell().textContent = log.action;
            row.insertCell().textContent = log.entity_type;
            row.insertCell().innerHTML = log.entity_id 
                ? `<code style="font-size: 0.8rem;">${log.entity_id.substring(0, 12)}...</code>`
                : '-';
            row.insertCell().innerHTML = `<pre style="font-size: 0.75rem; margin: 0;">${JSON.stringify(log.payload, null, 2).substring(0, 100)}...</pre>`;
        });
        
        // Pagination
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        if (data.pages > 1) {
            for (let i = 1; i <= data.pages; i++) {
                const span = document.createElement(i === page ? 'span' : 'a');
                span.textContent = i;
                span.className = i === page ? 'current' : '';
                if (i !== page) {
                    span.href = '#';
                    span.onclick = (e) => { e.preventDefault(); loadAudit(i, currentAction); };
                }
                pagination.appendChild(span);
            }
        }
    })
    .catch(e => {
        console.error('Failed to load audit:', e);
        document.getElementById('audit-table').innerHTML = '<tr><td colspan="6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
    });
}

loadAudit();
</script>
{% endblock %}
